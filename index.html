<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”Ÿæ—¥å€’è®¡æ—¶</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript@1.6.12/lunar.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f7f9fc; padding: 20px; max-width: 600px; margin: 0 auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .days-left { font-size: 1.5rem; font-weight: bold; color: #e74c3c; }
        .name { font-size: 1.1rem; font-weight: 600; }
        .date-info { font-size: 0.85rem; color: #666; margin-top: 4px; }
        .tag { font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; margin-left: 5px; }
        .tag.solar { background: #e3f2fd; color: #1976d2; }
        .tag.lunar { background: #f3e5f5; color: #7b1fa2; }
        .add-box { background: #fff; padding: 20px; border-radius: 12px; margin-top: 30px; }
        input, select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin: 5px 0; width: 100%; box-sizing: border-box; }
        button { background: #333; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; width: 100%; margin-top: 10px; }
        button:hover { background: #000; }
        .del-btn { color: #999; cursor: pointer; font-size: 0.8rem; margin-left: 10px;}
    </style>
</head>
<body>
    <div id="app">
        <h2>ğŸ‰ ç”Ÿæ—¥å€’è®¡æ—¶</h2>
        
        <div v-if="loading">åŠ è½½ä¸­...</div>

        <div v-for="(item, index) in sortedList" :key="index" class="card">
            <div>
                <div class="name">
                    {{ item.name }}
                    <span :class="['tag', item.type === 'solar' ? 'solar' : 'lunar']">
                        {{ item.type === 'solar' ? 'é˜³å†' : 'å†œå†' }}
                    </span>
                </div>
                <div class="date-info">
                    åŸæ—¥æœŸ: {{ item.date }} | ä¸‹æ¬¡: {{ item.nextDateStr }}
                </div>
            </div>
            <div style="text-align: right;">
                <div class="days-left">{{ item.days }} å¤©</div>
                <span class="del-btn" @click="removeItem(index)">åˆ é™¤</span>
            </div>
        </div>

        <div class="add-box">
            <h3>ğŸ“ å½•å…¥æ–°ç”Ÿæ—¥</h3>
            <input v-model="newItem.name" placeholder="å§“å">
            <select v-model="newItem.type">
                <option value="solar">é˜³å† (å…¬å†)</option>
                <option value="lunar">å†œå† (é˜´å†)</option>
            </select>
            <input type="text" v-model="newItem.date" placeholder="æ ¼å¼: 10-01 (æœˆ-æ—¥) æˆ– 1995-10-01">
            <button @click="addItem">ä¿å­˜</button>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;

        createApp({
            setup() {
                const list = ref([]);
                const loading = ref(true);
                const newItem = ref({ name: '', type: 'solar', date: '' });

                // è®¡ç®—å€’è®¡æ—¶é€»è¾‘
                const calculateDays = (item) => {
                    const today = new Date();
                    today.setHours(0,0,0,0);
                    const currentYear = today.getFullYear();
                    
                    let targetDate;
                    
                    // è§£æè¾“å…¥çš„ æœˆ-æ—¥
                    let [m, d] = item.date.includes('-') 
                        ? item.date.split('-').slice(-2).map(Number) 
                        : [0, 0];

                    if (item.type === 'solar') {
                        // --- é˜³å†é€»è¾‘ ---
                        targetDate = new Date(currentYear, m - 1, d);
                        if (targetDate < today) {
                            targetDate.setFullYear(currentYear + 1);
                        }
                    } else {
                        // --- å†œå†é€»è¾‘ (æ ¸å¿ƒ) ---
                        // è·å–ä»Šå¹´çš„å†œå†å¯¹åº”çš„å…¬å†æ—¥æœŸ
                        // Lunar.fromYmd(å¹´, æœˆ, æ—¥)
                        let lunarDate = Lunar.fromYmd(currentYear, m, d);
                        let solarFromLunar = lunarDate.getSolar();
                        targetDate = new Date(solarFromLunar.getYear(), solarFromLunar.getMonth() - 1, solarFromLunar.getDay());

                        // å¦‚æœä»Šå¹´çš„å†œå†ç”Ÿæ—¥å·²ç»è¿‡äº†ï¼Œè®¡ç®—æ˜å¹´çš„
                        if (targetDate < today) {
                            lunarDate = Lunar.fromYmd(currentYear + 1, m, d);
                            solarFromLunar = lunarDate.getSolar();
                            targetDate = new Date(solarFromLunar.getYear(), solarFromLunar.getMonth() - 1, solarFromLunar.getDay());
                        }
                    }

                    const diffTime = Math.abs(targetDate - today);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                    
                    return {
                        ...item,
                        days: diffDays,
                        nextDateStr: targetDate.toISOString().split('T')[0]
                    };
                };

                // è·å–æ’åºåçš„åˆ—è¡¨
                const sortedList = computed(() => {
                    return list.value.map(calculateDays).sort((a, b) => a.days - b.days);
                });

                // API æ“ä½œ
                const fetchData = async () => {
                    const res = await fetch('/api/data');
                    list.value = await res.json();
                    loading.value = false;
                };

                const addItem = async () => {
                    if(!newItem.value.name || !newItem.value.date) return alert("è¯·å¡«å†™å®Œæ•´");
                    list.value.push({ ...newItem.value });
                    await fetch('/api/data', {
                        method: 'POST',
                        body: JSON.stringify(list.value)
                    });
                    newItem.value = { name: '', type: 'solar', date: '' };
                };

                const removeItem = async (index) => {
                    // ç”±äº sortedList æ”¹å˜äº†é¡ºåºï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°åŸæ•°ç»„ä¸­çš„å¯¹åº”é¡¹åˆ é™¤
                    // è¿™é‡Œä¸ºäº†ç®€åŒ–æ¼”ç¤ºï¼Œç›´æ¥åœ¨å‰ç«¯UIç§»é™¤åå…¨é‡ä¿å­˜ã€‚
                    // å®é™…åº”ç”¨ä¸­å»ºè®®ç»™æ¯ä¸ªitemåŠ ä¸ª IDã€‚
                    const itemToRemove = sortedList.value[index];
                    const realIndex = list.value.findIndex(i => i.name === itemToRemove.name && i.date === itemToRemove.date);
                    
                    if(confirm('ç¡®å®šåˆ é™¤å—ï¼Ÿ')) {
                        list.value.splice(realIndex, 1);
                        await fetch('/api/data', {
                            method: 'POST',
                            body: JSON.stringify(list.value)
                        });
                    }
                };

                onMounted(fetchData);

                return { list, sortedList, newItem, addItem, removeItem, loading };
            }
        }).mount('#app');
    </script>
</body>
</html>
